<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Dá»± Ã¡n HRMS</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-left: 10px;
            border-left: 4px solid #3498db;
        }
        
        h3 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        .diagram-container {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .mermaid {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 4px;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 15px 0;
        }
        
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        ul, ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 30px;
        }
        
        .toc h3 {
            margin-top: 0;
        }
        
        .toc ul {
            list-style: none;
            margin-left: 0;
        }
        
        .toc a {
            color: #3498db;
            text-decoration: none;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        @media print {
            body {
                background: white;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ï¸ SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Dá»± Ã¡n HRMS</h1>
        
        <div class="info-box">
            <strong>Tá»•ng quan:</strong> Há»‡ thá»‘ng HRMS (Human Resource Management System) Ä‘Æ°á»£c xÃ¢y dá»±ng trÃªn ná»n táº£ng <strong>Next.js 14</strong> vá»›i kiáº¿n trÃºc Full-Stack, sá»­ dá»¥ng <strong>MySQL</strong> lÃ m database vÃ  <strong>JWT</strong> cho authentication.
        </div>
        
        <div class="toc">
            <h3>ğŸ“‘ Má»¥c lá»¥c</h3>
            <ul>
                <li><a href="#overview">1. Kiáº¿n trÃºc Tá»•ng thá»ƒ</a></li>
                <li><a href="#structure">2. Cáº¥u trÃºc ThÆ° má»¥c</a></li>
                <li><a href="#auth-flow">3. Luá»“ng XÃ¡c thá»±c</a></li>
                <li><a href="#authz-flow">4. Luá»“ng PhÃ¢n quyá»n</a></li>
                <li><a href="#database">5. Kiáº¿n trÃºc Database</a></li>
                <li><a href="#modules">6. CÃ¡c Module ChÃ­nh</a></li>
                <li><a href="#tech">7. CÃ´ng nghá»‡ Sá»­ dá»¥ng</a></li>
                <li><a href="#security">8. Security Features</a></li>
                <li><a href="#performance">9. Performance Optimizations</a></li>
            </ul>
        </div>
        
        <div class="section" id="overview">
            <h2>1. Kiáº¿n trÃºc Tá»•ng thá»ƒ</h2>
            <div class="diagram-container">
                <div class="mermaid">
graph TB
    subgraph "Client Layer"
        Browser[Browser/Client]
    end
    
    subgraph "Next.js Application"
        subgraph "Frontend (React)"
            Pages[Pages Components]
            Layout[Layout Component]
            AuthHook[useAuth Hook]
            UI[MUI Components]
        end
        
        subgraph "API Layer (Next.js API Routes)"
            AuthAPI[Auth API<br/>/api/auth/*]
            DeptAPI[Departments API<br/>/api/departments/*]
            EmpAPI[Employees API<br/>/api/employees/*]
            LeaveAPI[Leaves API<br/>/api/leaves/*]
            OTAPI[Overtime API<br/>/api/overtime/*]
            AdminAPI[Admin API<br/>/api/admin/*]
        end
        
        subgraph "Middleware & Services"
            AuthMW[Auth Middleware]
            RBAC[RBAC Service]
            Validation[Zod Validation]
            DBHelper[DB Helpers]
        end
        
        subgraph "Data Access Layer"
            DBPool[MySQL Connection Pool]
            Query[Query Functions]
        end
    end
    
    subgraph "Database (MySQL)"
        Users[(users)]
        Employees[(employees)]
        Departments[(departments)]
        Leaves[(leaves)]
        LeaveSessions[(leave_sessions)]
        Overtime[(overtime)]
        Roles[(roles)]
        Permissions[(permissions)]
        RolePerms[(role_permissions)]
        UserRoles[(user_roles)]
    end
    
    Browser --> Pages
    Pages --> Layout
    Pages --> AuthHook
    Pages --> UI
    AuthHook --> AuthAPI
    
    Pages --> AuthAPI
    Pages --> DeptAPI
    Pages --> EmpAPI
    Pages --> LeaveAPI
    Pages --> OTAPI
    Pages --> AdminAPI
    
    AuthAPI --> AuthMW
    DeptAPI --> AuthMW
    EmpAPI --> AuthMW
    LeaveAPI --> AuthMW
    OTAPI --> AuthMW
    AdminAPI --> AuthMW
    
    AuthMW --> RBAC
    AuthMW --> Validation
    AuthMW --> DBHelper
    
    DBHelper --> Query
    Query --> DBPool
    
    DBPool --> Users
    DBPool --> Employees
    DBPool --> Departments
    DBPool --> Leaves
    DBPool --> LeaveSessions
    DBPool --> Overtime
    DBPool --> Roles
    DBPool --> Permissions
    DBPool --> RolePerms
    DBPool --> UserRoles
                </div>
            </div>
        </div>
        
        <div class="section" id="structure">
            <h2>2. Cáº¥u trÃºc ThÆ° má»¥c</h2>
            <div class="code-block">
hrmsa2/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ api/                      # API Routes (Backend)
â”‚   â”‚   â”œâ”€â”€ auth/                 # Authentication endpoints
â”‚   â”‚   â”‚   â”œâ”€â”€ login/route.ts
â”‚   â”‚   â”‚   â””â”€â”€ register/route.ts
â”‚   â”‚   â”œâ”€â”€ departments/          # Department management
â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts          # GET, POST
â”‚   â”‚   â”‚   â””â”€â”€ [id]/route.ts     # GET, PUT, DELETE
â”‚   â”‚   â”œâ”€â”€ employees/            # Employee management
â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts
â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â”œâ”€â”€ route.ts
â”‚   â”‚   â”‚       â””â”€â”€ account/route.ts
â”‚   â”‚   â”œâ”€â”€ leaves/               # Leave management
â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts
â”‚   â”‚   â”‚   â””â”€â”€ [id]/route.ts
â”‚   â”‚   â”œâ”€â”€ overtime/             # Overtime management
â”‚   â”‚   â”‚   â”œâ”€â”€ route.ts
â”‚   â”‚   â”‚   â””â”€â”€ [id]/route.ts
â”‚   â”‚   â””â”€â”€ admin/               # RBAC administration
â”‚   â”‚       â”œâ”€â”€ roles/
â”‚   â”‚       â”œâ”€â”€ permissions/
â”‚   â”‚       â””â”€â”€ users/
â”‚   â”œâ”€â”€ departments/page.tsx     # Department page (Frontend)
â”‚   â”œâ”€â”€ employees/page.tsx        # Employee page
â”‚   â”œâ”€â”€ leaves/page.tsx           # Leave page
â”‚   â”œâ”€â”€ overtime/page.tsx          # Overtime page
â”‚   â”œâ”€â”€ admin/                    # Admin pages
â”‚   â”‚   â”œâ”€â”€ roles/page.tsx
â”‚   â”‚   â””â”€â”€ users/page.tsx
â”‚   â”œâ”€â”€ login/page.tsx            # Login page
â”‚   â”œâ”€â”€ page.tsx                  # Dashboard
â”‚   â””â”€â”€ layout.tsx                # Root layout
â”‚
â”œâ”€â”€ components/                   # React Components
â”‚   â”œâ”€â”€ Layout.tsx                # Main layout with sidebar
â”‚   â””â”€â”€ ThemeProvider.tsx         # MUI theme provider
â”‚
â”œâ”€â”€ hooks/                        # React Hooks
â”‚   â””â”€â”€ useAuth.tsx               # Authentication hook
â”‚
â”œâ”€â”€ lib/                          # Shared Libraries
â”‚   â”œâ”€â”€ db.ts                     # Database connection pool
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.ts               # Auth & RBAC middleware
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ index.ts              # TypeScript types
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ auth.ts               # JWT & password utilities
â”‚       â”œâ”€â”€ validation.ts        # Zod schemas
â”‚       â”œâ”€â”€ db-helpers.ts         # Database helpers
â”‚       â””â”€â”€ leave-helpers.ts      # Leave calculation helpers
â”‚
â”œâ”€â”€ database/                     # Database Schemas
â”‚   â”œâ”€â”€ schema.sql                # Main schema
â”‚   â”œâ”€â”€ rbac-schema.sql           # RBAC tables
â”‚   â””â”€â”€ migration-*.sql          # Migration scripts
â”‚
â””â”€â”€ scripts/                      # Utility Scripts
    â”œâ”€â”€ init-db.ts                # Initialize database
    â”œâ”€â”€ create-admin.js           # Create admin user
    â””â”€â”€ migrate-*.js              # Migration scripts
            </div>
        </div>
        
        <div class="section" id="auth-flow">
            <h2>3. Luá»“ng XÃ¡c thá»±c (Authentication Flow)</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant Client
    participant LoginPage
    participant AuthAPI
    participant AuthMW
    participant DB
    participant useAuth

    Client->>LoginPage: Nháº­p username/password
    LoginPage->>AuthAPI: POST /api/auth/login
    AuthAPI->>DB: Query user by username
    DB-->>AuthAPI: User data
    AuthAPI->>DB: Get user permissions (RBAC)
    DB-->>AuthAPI: Permissions list
    AuthAPI->>AuthAPI: Generate JWT token
    AuthAPI-->>LoginPage: { token, user, permissions }
    LoginPage->>useAuth: login(token, user, permissions)
    useAuth->>useAuth: Store in localStorage
    useAuth->>Client: Redirect to dashboard
                </div>
            </div>
        </div>
        
        <div class="section" id="authz-flow">
            <h2>4. Luá»“ng PhÃ¢n quyá»n (Authorization Flow)</h2>
            <div class="diagram-container">
                <div class="mermaid">
sequenceDiagram
    participant Client
    participant Page
    participant API
    participant AuthMW
    participant RBAC
    participant DB

    Client->>Page: Request protected page
    Page->>useAuth: Check authentication
    useAuth-->>Page: User & permissions
    Page->>Page: Check hasPermission()
    Page->>API: API request with JWT
    API->>AuthMW: requireAuth(request)
    AuthMW->>AuthMW: Verify JWT token
    AuthMW->>RBAC: Check permission
    RBAC->>DB: Query user permissions
    DB-->>RBAC: Permissions
    RBAC-->>AuthMW: Has permission?
    AuthMW-->>API: Authorized
    API->>DB: Execute query
    DB-->>API: Data
    API-->>Page: Response
    Page-->>Client: Render UI
                </div>
            </div>
        </div>
        
        <div class="section" id="database">
            <h2>5. Kiáº¿n trÃºc Database</h2>
            <div class="diagram-container">
                <div class="mermaid">
erDiagram
    users ||--o{ user_roles : has
    users ||--o| employees : "linked to"
    
    roles ||--o{ user_roles : assigned
    roles ||--o{ role_permissions : has
    
    permissions ||--o{ role_permissions : assigned
    
    departments ||--o{ employees : contains
    departments ||--o| employees : "managed by"
    
    employees ||--o{ leaves : requests
    employees ||--o{ overtime : requests
    employees ||--o{ users : "has account"
    
    leaves ||--o{ leave_sessions : has
    leaves ||--o| users : "approved by"
    
    users {
        int id PK
        string username
        string email
        string password
        enum role
        int employeeId FK
    }
    
    employees {
        int id PK
        string code
        string firstName
        string lastName
        int departmentId FK
    }
    
    departments {
        int id PK
        string name
        string code
        int managerId FK
    }
    
    leaves {
        int id PK
        int employeeId FK
        enum type
        date startDate
        date endDate
        decimal days
        text reason
        enum status
        int approvedBy FK
    }
    
    leave_sessions {
        int id PK
        int leaveId FK
        date date
        enum sessionType
    }
    
    overtime {
        int id PK
        int employeeId FK
        date date
        decimal hours
        text reason
        enum status
        int approvedBy FK
    }
    
    roles {
        int id PK
        string code
        string name
        boolean isActive
        boolean isSystem
    }
    
    permissions {
        int id PK
        string code
        string name
        string module
    }
    
    role_permissions {
        int roleId FK
        int permissionId FK
    }
    
    user_roles {
        int userId FK
        int roleId FK
    }
                </div>
            </div>
        </div>
        
        <div class="section" id="modules">
            <h2>6. CÃ¡c Module ChÃ­nh</h2>
            
            <h3>1. Authentication & Authorization</h3>
            <ul>
                <li><strong>JWT-based authentication</strong>: Token Ä‘Æ°á»£c lÆ°u trong localStorage</li>
                <li><strong>RBAC (Role-Based Access Control)</strong>:
                    <ul>
                        <li>Roles: Admin, HR, Manager, Employee</li>
                        <li>Permissions: Fine-grained permissions per module</li>
                        <li>Dynamic permission checking</li>
                    </ul>
                </li>
            </ul>
            
            <h3>2. Department Management</h3>
            <ul>
                <li>CRUD operations</li>
                <li>Manager assignment</li>
                <li>Permission-based access control</li>
            </ul>
            
            <h3>3. Employee Management</h3>
            <ul>
                <li>CRUD operations</li>
                <li>Account creation for employees</li>
                <li>Department linking</li>
            </ul>
            
            <h3>4. Leave Management</h3>
            <ul>
                <li>Create leave requests</li>
                <li>Session-based leave (morning/afternoon)</li>
                <li>Half-day leave support (0.5 days)</li>
                <li>Approval workflow</li>
                <li>Separate <code>leave_sessions</code> table for session tracking</li>
            </ul>
            
            <h3>5. Overtime Management</h3>
            <ul>
                <li>Create overtime requests</li>
                <li>Hours tracking</li>
                <li>Approval workflow</li>
            </ul>
            
            <h3>6. RBAC Administration</h3>
            <ul>
                <li>Role management</li>
                <li>Permission management</li>
                <li>User-role assignment</li>
                <li>Permission-role assignment</li>
            </ul>
        </div>
        
        <div class="section" id="tech">
            <h2>7. CÃ´ng nghá»‡ Sá»­ dá»¥ng</h2>
            
            <h3>Frontend</h3>
            <ul>
                <li><strong>Next.js 14</strong> (App Router)</li>
                <li><strong>React 18</strong></li>
                <li><strong>Material-UI (MUI)</strong> v5</li>
                <li><strong>TypeScript</strong></li>
                <li><strong>date-fns</strong> (Date manipulation)</li>
            </ul>
            
            <h3>Backend</h3>
            <ul>
                <li><strong>Next.js API Routes</strong></li>
                <li><strong>MySQL 8.0+</strong> (mysql2/promise)</li>
                <li><strong>JWT</strong> (jsonwebtoken)</li>
                <li><strong>bcryptjs</strong> (Password hashing)</li>
                <li><strong>Zod</strong> (Schema validation)</li>
            </ul>
            
            <h3>Database</h3>
            <ul>
                <li><strong>MySQL</strong> vá»›i InnoDB engine</li>
                <li>Connection pooling</li>
                <li>Foreign key constraints</li>
                <li>Indexes for performance</li>
            </ul>
        </div>
        
        <div class="section" id="security">
            <h2>8. Security Features</h2>
            <ol>
                <li><strong>Password Hashing</strong>: bcryptjs vá»›i salt rounds</li>
                <li><strong>JWT Tokens</strong>: Secure token generation vÃ  validation</li>
                <li><strong>SQL Injection Prevention</strong>: Prepared statements</li>
                <li><strong>RBAC</strong>: Fine-grained permission control</li>
                <li><strong>Input Validation</strong>: Zod schemas cho táº¥t cáº£ inputs</li>
                <li><strong>CORS</strong>: Next.js built-in CORS handling</li>
            </ol>
        </div>
        
        <div class="section" id="performance">
            <h2>9. Performance Optimizations</h2>
            <ol>
                <li><strong>Connection Pooling</strong>: MySQL connection pool vá»›i limit 5</li>
                <li><strong>Global Pool</strong>: Singleton pattern Ä‘á»ƒ trÃ¡nh multiple pools</li>
                <li><strong>Indexes</strong>: Database indexes trÃªn cÃ¡c cá»™t thÆ°á»ng query</li>
                <li><strong>Pagination</strong>: API pagination cho large datasets</li>
                <li><strong>Client-side Caching</strong>: localStorage cho auth state</li>
            </ol>
        </div>
        
        <div class="section">
            <h2>10. Deployment Considerations</h2>
            <ul>
                <li>Environment variables: <code>.env.local</code></li>
                <li>Database migrations: Script-based migrations</li>
                <li>Build: <code>npm run build</code></li>
                <li>Production: <code>npm start</code></li>
                <li>Database connection: Configurable via env vars</li>
            </ul>
        </div>
    </div>
    
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                bottomMarginAdj: 1,
                useMaxWidth: true,
                rightAngles: false,
                showSequenceNumbers: false
            },
            er: {
                fontSize: 12,
                useMaxWidth: true
            }
        });
    </script>
</body>
</html>

